<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.okdeer.mall.operate.skinmanager.mapper.OperateSkinManagerMapper" >
    <resultMap id="BaseResultMap" type="com.okdeer.mall.operate.dto.SkinManagerDto" >
        <id column="id" property="id" jdbcType="VARCHAR" />
        <result column="activity_name" property="activityName" jdbcType="VARCHAR" />
        <result column="skin_module" property="skinModule" jdbcType="VARCHAR" javaType="com.okdeer.mall.operate.enums.SkinModule"/>
        <result column="start_time" property="startTime" jdbcType="TIMESTAMP" />
        <result column="end_time" property="endTime" jdbcType="TIMESTAMP" />
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
        <result column="create_user_id" property="createUserId" jdbcType="VARCHAR" />
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
        <result column="update_user_id" property="updateUserId" jdbcType="VARCHAR" />
        <result column="status" property="status" jdbcType="VARCHAR" javaType="com.okdeer.mall.operate.enums.SkinManagerStatus"/>
    
	    <collection property="detail" ofType="com.okdeer.mall.operate.entity.SkinManagerDetail" >
		       <id  column="id" property="detailId" jdbcType="VARCHAR" /> 
		       <result column="skin_manager_id" property="skinManagerId" jdbcType="VARCHAR" />
		       <result column="module_name" property="moduleName" jdbcType="VARCHAR" />
		       <result column="init_module" property="initModule" jdbcType="VARCHAR" />
		       <result column="init_img_url" property="initImgUrl" jdbcType="VARCHAR" />
		       <result column="selected_img_url" property="selectedImgUrl" jdbcType="VARCHAR" />
		</collection > 
    
    </resultMap>

    <sql id="Base_Column_List" >
        id, activity_name, skin_module, start_time, end_time, create_time, create_user_id, 
        update_time, update_user_id, disabled, status
    </sql>
    
	<!-- 根据条件搜索皮肤列表 -->
  <select id="findSkinList" resultMap="BaseResultMap" parameterType="com.okdeer.mall.operate.dto.SkinManagerDto">
    SELECT 
    <include refid="Base_Column_List" />
     FROM operate_skin_manager 
     WHERE 1=1
       <!-- 未被删除的 -->
       AND disabled = 0
       <!-- 活动名称 -->
       <if test="activityName != null and activityName != ''">
         AND activity_name LIKE CONCAT('%',#{activityName,jdbcType=VARCHAR},'%') 
       </if>
       <!-- 活动状态 -->
       <if test="status != null">
         AND status = #{status,jdbcType=VARCHAR}
       </if>
       <!-- 创建时间 -->
       <if test="createTimeStart != null">
         AND create_time <![CDATA[ >= ]]> #{createTimeStart,jdbcType=TIMESTAMP}
       </if>
       <if test="createTimeEnd != null">
         AND create_time <![CDATA[ <= ]]> #{createTimeEnd,jdbcType=TIMESTAMP}
       </if>
       <!-- 活动开始时间 -->
       <if test="startTime != null">
         AND start_time <![CDATA[ >= ]]> #{startTime,jdbcType=TIMESTAMP}
       </if>
       <!-- 活动结束时间 -->
       <if test="endTime != null">
         AND end_time <![CDATA[ <= ]]> #{endTime,jdbcType=TIMESTAMP}
       </if>
       ORDER BY create_time DESC
  </select>
  
    <select id="findById" resultMap="BaseResultMap" parameterType="java.lang.String" >
        select 
        <include refid="Base_Column_List" />
        
        from operate_skin_manager skin left join operate_skin_manager_detail detail
        on skin.id = detail.skin_manager_id
        where id = #{id,jdbcType=VARCHAR}
    </select>

    <insert id="add" parameterType="com.okdeer.mall.operate.entity.SkinManager" >
        insert into operate_skin_manager
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="id != null" >
                id,
            </if>
            <if test="activity_name != null" >
                activity_name,
            </if>
            <if test="skin_module != null" >
                skin_module,
            </if>
            <if test="start_time != null" >
                start_time,
            </if>
            <if test="end_time != null" >
                end_time,
            </if>
            <if test="create_time != null" >
                create_time,
            </if>
            <if test="create_user_id != null" >
                create_user_id,
            </if>
            <if test="update_time != null" >
                update_time,
            </if>
            <if test="update_user_id != null" >
                update_user_id,
            </if>
            <if test="disabled != null" >
                disabled,
            </if>
            <if test="status != null" >
                status,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="id != null" >
                #{id,jdbcType=VARCHAR},
            </if>
            <if test="activityName != null" >
                #{activityName,jdbcType=VARCHAR},
            </if>
            <if test="skinModule != null" >
                #{skinModule,jdbcType=VARCHAR},
            </if>
            <if test="startTime != null" >
                #{startTime,jdbcType=TIMESTAMP},
            </if>
            <if test="endTime != null" >
                #{endTime,jdbcType=TIMESTAMP},
            </if>
            <if test="createTime != null" >
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="createUserId != null" >
                #{createUserId,jdbcType=VARCHAR},
            </if>
            <if test="updateTime != null" >
                #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateUserId != null" >
                #{updateUserId,jdbcType=VARCHAR},
            </if>
            <if test="disabled != null" >
                #{disabled,jdbcType=TINYINT},
            </if>
            <if test="status != null" >
                #{status,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>

    <update id="update" parameterType="com.okdeer.mall.operate.entity.SkinManager" >
        update operate_skin_manager
        <set >
            <if test="activityName != null" >
                activity_name = #{activityName,jdbcType=VARCHAR},
            </if>
            <if test="skin_module != null" >
                skin_module = #{skinModule,jdbcType=VARCHAR},
            </if>
            <if test="start_time != null" >
                start_time = #{startTime,jdbcType=TIMESTAMP},
            </if>
            <if test="end_time != null" >
                end_time = #{endTime,jdbcType=TIMESTAMP},
            </if>
            <if test="create_time != null" >
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="create_user_id != null" >
                create_user_id = #{createUserId,jdbcType=VARCHAR},
            </if>
            <if test="update_time != null" >
                update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="update_user_id != null" >
                update_user_id = #{updateUserId,jdbcType=VARCHAR},
            </if>
            <if test="disabled != null" >
                disabled = #{disabled,jdbcType=TINYINT},
            </if>
            <if test="status != null" >
                status = #{status,jdbcType=VARCHAR},
            </if>
        </set>
        where id = #{id,jdbcType=VARCHAR}
    </update>

    <delete id="delete" parameterType="java.lang.String" >
        delete from operate_skin_manager
        where id = #{id,jdbcType=VARCHAR}
    </delete>
    <!--根据皮肤id,逻辑活动皮肤  -->
  <update id="deleteSkinById" parameterType="com.okdeer.mall.operate.dto.SkinManagerDto">
	 UPDATE operate_skin_manager
	 SET disabled = 1,
	     update_time = #{updateTime,jdbcType=TIMESTAMP},
	     update_user_id = #{updateUserId,jdbcType=VARCHAR}
	 WHERE id = #{id,jdbcType=VARCHAR}
  </update>
 <!--根据皮肤id,关闭活动皮肤  -->
  <update id="closeSkinById" parameterType="com.okdeer.mall.operate.dto.SkinManagerDto">
	 UPDATE operate_skin_manager
	 SET status = #{status,jdbcType=VARCHAR},
	     update_time = #{updateTime,jdbcType=TIMESTAMP},
	     update_user_id = #{updateUserId,jdbcType=VARCHAR}
	 WHERE disabled = 0 and id = #{id,jdbcType=VARCHAR}
  </update>
  
 <!-- 查询某固定时间段内是否有运行中的皮肤 -->
   <select id="selectSkinByTime" resultType="int" parameterType="com.okdeer.mall.operate.dto.SkinManagerDto" >
    SELECT 	count(1)
     FROM operate_skin_manager 
     <!-- 未被删除的 -->
     WHERE disabled = 0
       <!-- 状态为未开始和进行中 -->
       AND status ='underWay'    
       AND (#{startTime,jdbcType=TIMESTAMP} BETWEEN start_time and end_time 
       OR #{endTime,jdbcType=TIMESTAMP} BETWEEN start_time and end_time 
       OR (start_time <![CDATA[ >= ]]> #{startTime,jdbcType=TIMESTAMP} and end_time <![CDATA[ <= ]]> #{endTime,jdbcType=TIMESTAMP}))
  </select>
   <!-- 根据名称查询是否有运行中的皮肤 -->
   <select id="selectSkinCountByName" resultType="int" parameterType="com.okdeer.mall.operate.dto.SkinManagerDto" >
    SELECT 	count(1)
     FROM operate_skin_manager 
     <!-- 未被删除的 -->
     WHERE disabled = 0 and activity_name=#{activityName,jdbcType=VARCHAR}
       </select>
</mapper>